{% extends 'admin_panel/base.html' %}
{% load static %}

{% block title %}Doctor Overview / Patients Record - SmartSight{% endblock %}

{% block content %}
    <style>
        /* Your existing CSS styles... */
    </style>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">Doctor Overview / Patients Record</h2>
        <div class="input-group search-input-group">
            <input type="text" id="searchInput" class="form-control" placeholder="Search">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
        </div>
    </div>

    <div id="patientsRecordTable">
        <table class="table mt-3">
            <thead>
                <tr>
                    <th>Last Name</th>
                    <th>First Name</th>
                    <th>Age</th>
                    <th>Appointment Date & Time</th>
                    <th>Severity</th>
                    <th>View Details</th>
                    <th>Archive</th>
                </tr>
            </thead>
            <tbody>
                {% for patient in patients %}
                <tr>
                    <td>{{ patient.patient_last_name }}</td>
                    <td>{{ patient.patient_first_name }}</td>
                    <td>{{ patient.patient_age }}</td>
                    <td>{{ patient.appointment_datetime|date:"F d, Y P" }}</td>
                    <td>
                        <span class="badge-status {{ patient.severity|lower }}">{{ patient.severity }}</span>
                    </td>
                    <td>
                        <button class="view-details-btn" data-id="{{ patient.id }}">View Details</button>
                    </td>
                    <td>
                        <button class="archive-btn" data-id="{{ patient.id }}"><i class="bi bi-download"></i></button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="text-center">No patient records found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% endblock content %}

{% block extra_js %}
    <script>
        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function () {
            let filter = this.value.toLowerCase();
            let rows = document.querySelectorAll('#patientsRecordTable tbody tr');
            rows.forEach(row => {
                let text = row.textContent.toLowerCase();
                row.style.display = text.includes(filter) ? '' : 'none';
            });
        });

        // AJAX for Archive button
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('patientsRecordTable').addEventListener('click', function(event) {
                if (event.target.closest('.archive-btn')) {
                    const button = event.target.closest('.archive-btn');
                    const patientId = button.dataset.id;
                    
                    if (confirm('Are you sure you want to archive this patient record?')) {
                        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                        
                        fetch('{% url "archive_patient" %}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                                'X-CSRFToken': csrfToken
                            },
                            body: `id=${patientId}`
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert(data.message);
                                button.closest('tr').remove();
                            } else {
                                alert('Error: ' + data.error);
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('An error occurred while archiving.');
                        });
                    }
                }
            });

            // View Details button handler (remains the same as it's a placeholder)
            document.querySelectorAll('.view-details-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const patientId = this.dataset.id;
                    console.log('View Details button clicked for patient ID:', patientId);
                    alert('Viewing details for Patient ID: ' + patientId + ' (Backend integration needed)');
                });
            });
        });
    </script>
{% endblock %}